var census_uri="http://census.soe.com/get/ps2-beta";var census_serviceid="";function ContinentViewModel(a,c){var b=this;b.subscriptions=[];b.zone=ko.observable(c);b.regions=ko.observableArray();b.regionHistory=ko.observableArray();b.loading=ko.observable(true);b.timer=0;b.name=ko.computed(function(){var d=a.zones()[b.zone()-1];if(d){return d.name.en}return null});b.owned=function(d){regions=a.getRegionIds(a.warpgates());return $.grep(b.regions(),function(f,e){return f.RowData.FactionId==d&&regions.indexOf(f.RowData.RegionId)<0})};b.ownedFacilities=function(d){return $.grep(b.regions(),function(f,e){return f.RowData.FactionId==d&&a.facilityRegions().indexOf(f.RowData.RegionId)>-1}).length};b.warpgates=ko.computed(function(){regions=a.getRegionIds(a.warpgates());return $.grep(b.regions(),function(e,d){return regions.indexOf(e.RowData.RegionId)>-1}).length});b.neutral=ko.computed(function(){return b.owned(0).length+b.warpgates()});b.facilities=ko.computed(function(){return $.grep(b.regions(),function(e,d){return a.facilityRegions().indexOf(e.RowData.RegionId)>-1}).length});b.hasBonusFor=function(f){var e=Enumerable.From(a.facilities()).Where("$.facility_type.id == "+f).ToArray();var d=$.grep(e,function(g){return $.grep(b.regions(),function(h){return((g.region_id==h.RowData.RegionId)&&(h.RowData.FactionId==a.empire()))}).length>0});return d.length};b.hasBioBonus=ko.computed(function(){return b.hasBonusFor(3)});b.hasTechBonus=ko.computed(function(){return b.hasBonusFor(4)});b.hasAmpBonus=ko.computed(function(){return b.hasBonusFor(2)});b.calculateResources=function(d){return Enumerable.From(b.owned(a.empire())).Sum(function(e){region=a.regionLookup().Get(e.RowData.RegionId);reward=region.map_region_id.hex_reward.reward_group_id_list[0].reward_id;if(reward.resource_type.id==d){return parseInt(reward.reward_amount)}else{return 0}})};b.totals=ko.computed(function(){var d=a.empire();var e=b.owned(d);return{regions:e.length,facilities:b.ownedFacilities(d),infantry:b.calculateResources(4),mechanized:b.calculateResources(3),aerospace:b.calculateResources(2)}});b.factions=ko.computed(function(){return{vs:b.owned(1).length,nc:b.owned(2).length,tr:b.owned(3).length}});b.total=ko.computed(function(){return b.regions().length-b.neutral()});b.percentage=function(d){return(d/b.total()*100)};b.status=ko.computed(function(){var d=b.totals().regions;var e=b.percentage(d);if(e>a.tresholdTerritoryHigh()){return 1}if(e>a.tresholdTerritoryLow()){return 0}return -1});b.refresh=function(){b.loading(true);$.ajax({url:census_uri+"/map",data:{world_id:a.world,zone_ids:c},dataType:"jsonp",success:function(d,e){b.regions(d.map_list[0].Regions.Row);b.loading(false)}})};b.updateRefreshInterval=function(d){clearInterval(b.timer);b.timer=setInterval(b.refresh,d*1000)};b.dispose=function(){for(var d in b.subscriptions){b.subscriptions[d].dispose()}};b.subscriptions.push(a.refreshInterval.subscribe(b.updateRefreshInterval));b.updateRefreshInterval(a.refreshInterval());b.refresh()}function WorldViewModel(c,a){var b=this;b.world=ko.observable();b.empire=ko.observable(a);b.zones=ko.observableArray();b.continents=ko.observableArray();b.regions=ko.observableArray();b.worlds=ko.observableArray();b.refreshInterval=ko.observable(20);b.tresholdTerritoryHigh=ko.observable(33.33);b.tresholdTerritoryLow=ko.observable(10);b.getRegionIds=function(d){return Enumerable.From(d).Select("$.region_id").ToArray()};b.facilities=ko.computed(function(){return Enumerable.From(b.regions()).Where("['2','3','4'].indexOf($.facility_type.id) > -1").ToArray()});b.warpgates=ko.computed(function(){return Enumerable.From(b.regions()).Where("$.facility_type.id == 7").ToArray()});b.facilityRegions=ko.computed(function(){return b.getRegionIds(b.facilities())});b.regionLookup=ko.computed(function(){return Enumerable.From(b.regions()).ToDictionary("$.region_id","$")});b.loadContinents=function(){for(var d in b.continents()){b.continents()[d].dispose()}b.continents.removeAll();b.continents.push(new ContinentViewModel(b,2));b.continents.push(new ContinentViewModel(b,6));b.continents.push(new ContinentViewModel(b,8))};b.loadWorlds=function(){return $.ajax({url:census_uri+"/world",dataType:"jsonp",success:function(d,e){b.worlds(d.world_list);b.world(c)}})};b.loadZones=function(){return $.ajax({url:census_uri+"/zone",data:{"c:limit":100},dataType:"jsonp",success:function(d,e){b.zones(d.zone_list)}})};b.loadFacilities=function(d){return $.ajax({url:census_uri+"/"+d+"map",data:{"c:limit":100},dataType:"jsonp",success:function(f,g){var e=b.regions();ko.utils.arrayPushAll(e,f[d+"map_list"]);b.regions(e)}})};b.world.subscribe(function(d){b.loadContinents()});$.when(b.loadZones(),b.loadFacilities("indar"),b.loadFacilities("amerish"),b.loadFacilities("esamir")).done(function(){b.loadWorlds(c)})}$(function(){ko.applyBindings(new WorldViewModel(9,2))});