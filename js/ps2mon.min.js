var census_serviceid="apondman";var census_app="ps2-beta";var census_uri="http://census.soe.com/s:"+census_serviceid+"/get/"+census_app+"/";var app_uri=$.url();function ContinentViewModel(a,c){var b=this;b.subscriptions=[];b.zone=ko.observable(c);b.regions=ko.observableArray();b.history=ko.observableArray();b.loading=ko.observable(true);b.bonus=ko.observable(-1);b.timer=0;b.name=ko.computed(function(){var d=a.zones()[b.zone()-1];if(d){return d.name.en}return null});b.owned=function(d){regions=a.getRegionIds(a.warpgates());return $.grep(b.regions(),function(g,e){return g.RowData.FactionId==d&&regions.indexOf(g.RowData.RegionId)<0})};b.ownedFacilities=function(d){return $.grep(b.regions(),function(g,e){return g.RowData.FactionId==d&&a.facilityRegions().indexOf(g.RowData.RegionId)>-1}).length};b.toggleBonus=function(){var d=b.bonus();var e=a.empire();switch(d){case -1:case 0:b.bonus(e);break;case e:b.bonus(0);break}};b.warpgates=ko.computed(function(){regions=a.getRegionIds(a.warpgates());return $.grep(b.regions(),function(e,d){return regions.indexOf(e.RowData.RegionId)>-1}).length});b.neutral=ko.computed(function(){return b.owned(0).length+b.warpgates()});b.facilities=ko.computed(function(){return $.grep(b.regions(),function(e,d){return a.facilityRegions().indexOf(e.RowData.RegionId)>-1}).length});b.hasBonusFor=function(g){var e=Enumerable.From(a.facilities()).Where("$.facility_type.id == "+g).ToArray();var d=$.grep(e,function(h){return $.grep(b.regions(),function(i){return((h.region_id==i.RowData.RegionId)&&(i.RowData.FactionId==a.empire()))}).length>0});return d.length};b.hasContinentBonus=ko.computed(function(){return b.bonus()==a.empire()});b.hasBioBonus=ko.computed(function(){return b.hasBonusFor(3)});b.hasTechBonus=ko.computed(function(){return b.hasBonusFor(4)});b.hasAmpBonus=ko.computed(function(){return b.hasBonusFor(2)});b.calculateResources=function(e,d){return Enumerable.From(b.owned(d)).Sum(function(g){region=a.regionLookup().Get(g.RowData.RegionId);reward=region.map_region_id.hex_reward.reward_group_id_list[0].reward_id;if(reward.resource_type.id==e){return parseInt(reward.reward_amount)}else{return 0}})};b.factions=ko.computed(function(){return{vs:b.owned(1).length,nc:b.owned(2).length,tr:b.owned(3).length}});b.total=ko.computed(function(){return b.regions().length-b.neutral()});b.percentage=function(d){return(d/b.total()*100)};b.calculateTotals=function(d){var e=b.owned(d);return{faction:d,regions:e.length,facilities:b.ownedFacilities(d),infantry:b.calculateResources(4,d),mechanized:b.calculateResources(3,d),aerospace:b.calculateResources(2,d)}};b.totals=ko.computed(function(){return b.calculateTotals(a.empire())});b.captureRate=ko.computed(function(){var d=Enumerable.From(b.history()).Where("$.faction == "+a.empire()).Select("$.regions").Average();return(b.totals().regions/d)});b.captureRatePercentage=ko.computed(function(){return(b.captureRate()*100-100).toFixed(1)});b.status=ko.computed(function(){var d=b.totals().regions;var e=b.percentage(d);if(e>a.tresholdTerritoryHigh()){return 1}if(e>a.tresholdTerritoryLow()){return 0}return -1});b.computeValuesAndHistory=function(h){var d=b.history();if(d.length==120){d.splice(0,3)}for(var e=1;e<4;e++){var g=b.calculateTotals(e);if(g.regions==0&&b.bonus()==e){b.bonus(0)}else{if(g.regions==b.total()){b.bonus(e)}}d.push(g)}b.history(d)};b.showMap=function(){var d=a.openMap();d.setContinent(b.name().toLowerCase())};b.refresh=function(){b.loading(true);$.ajax({url:census_uri+"map",data:{world_id:a.world,zone_ids:c},dataType:"jsonp",success:function(d,e){b.regions(d.map_list[0].Regions.Row);b.loading(false)}})};b.updateRefreshInterval=function(d){clearInterval(b.timer);b.timer=setInterval(b.refresh,d*1000)};b.dispose=function(){for(var d in b.subscriptions){b.subscriptions[d].dispose()}};b.subscriptions.push(a.refreshInterval.subscribe(b.updateRefreshInterval));b.subscriptions.push(b.regions.subscribe(b.computeValuesAndHistory));b.updateRefreshInterval(a.refreshInterval());b.refresh()}function WorldViewModel(c,a){var b=this;b.mapTimer=0;b.map=null;b.showmap=ko.observable(false);b.worlds=ko.observableArray();b.world=ko.observable(c);b.empire=ko.observable(a);b.zones=ko.observableArray();b.continents=ko.observableArray();b.regions=ko.observableArray();b.refreshInterval=ko.observable(20);b.tresholdTerritoryHigh=ko.observable(33.33);b.tresholdTerritoryLow=ko.observable(10);b.factions=ko.observableArray([{id:1,name:"Vanu Sovereignty"},{id:2,name:"New Conglomerate"},{id:3,name:"Terran Republic"},]);b.bookmarkUrl=ko.computed(function(){return app_uri.attr("protocol")+"://"+app_uri.attr("host")+app_uri.attr("path")+"?w="+b.world()+"&f="+b.empire()});b.name=ko.computed(function(){return Enumerable.From(b.worlds()).Where("$.server_id == "+b.world()).Select("$.name.en").ToArray()});b.getRegionIds=function(d){return Enumerable.From(d).Select("$.region_id").ToArray()};b.facilities=ko.computed(function(){return Enumerable.From(b.regions()).Where("['2','3','4'].indexOf($.facility_type.id) > -1").ToArray()});b.warpgates=ko.computed(function(){return Enumerable.From(b.regions()).Where("$.facility_type.id == 7").ToArray()});b.facilityRegions=ko.computed(function(){return b.getRegionIds(b.facilities())});b.regionLookup=ko.computed(function(){return Enumerable.From(b.regions()).ToDictionary("$.region_id","$")});b.loadContinents=function(){for(var d in b.continents()){b.continents()[d].dispose()}b.continents.removeAll();b.continents.push(new ContinentViewModel(b,2));b.continents.push(new ContinentViewModel(b,6));b.continents.push(new ContinentViewModel(b,8))};b.loadWorlds=function(){return $.ajax({url:census_uri+"world?",dataType:"jsonp",success:function(d,e){list=d.world_list;list.sort(function(g,h){return g.name.en>h.name.en});b.worlds(list)}})};b.loadZones=function(){return $.ajax({url:census_uri+"zone",data:{"c:limit":100},dataType:"jsonp",success:function(d,e){b.zones(d.zone_list)}})};b.loadFacilities=function(d){return $.ajax({url:census_uri+d+"map?",data:{"c:limit":100},dataType:"jsonp",success:function(g,h){var e=b.regions();ko.utils.arrayPushAll(e,g[d+"map_list"]);b.regions(e)}})};b.openMap=function(){b.showmap(true);if(!b.map){b.map=new ps2hq.Map("mapContainer");b.map.showGrid(false)}ps2hq.map.SectorHelper.stopAutoUpdateSectors(b.mapTimer);b.mapTimer=ps2hq.map.SectorHelper.autoUpdateSectors(b.map,{worldId:b.world(),serviceId:census_serviceid,interval:b.refreshInterval()});$(".continent-control").hide();return b.map};b.closeMap=function(){ps2hq.map.SectorHelper.stopAutoUpdateSectors(b.mapTimer);b.showmap(false)};b.selectText=function(d,e){$(e.target).select()};b.world.subscribe(function(d){if(b.showmap()==true){ps2hq.map.SectorHelper.stopAutoUpdateSectors(b.mapTimer);b.mapTimer=ps2hq.map.SectorHelper.autoUpdateSectors(b.map,{worldId:d,serviceId:census_serviceid,interval:b.refreshInterval()})}b.loadContinents()});$.when(b.loadZones(),b.loadFacilities("indar"),b.loadFacilities("amerish"),b.loadFacilities("esamir")).done(function(){b.loadWorlds()})}$(function(){w=app_uri.param("w");f=app_uri.param("f");w=(undefined!=w)?parseInt(w):0;f=(undefined!=f)?parseInt(f):0;ko.applyBindings(new WorldViewModel(w,f))});